# üöÄ Full CI/CD Pipeline with Terraform + Ansible

---

## üì¶ Overview

This guide walks through a full **CI/CD pipeline** using:

- **Terraform** ‚Üí Provision AWS infrastructure (EC2, VPC, etc.)
- **Ansible** ‚Üí Configure EC2 (install NGINX, deploy app)
- **Git + GitHub Actions (or GitLab CI, Jenkins, etc.)** ‚Üí Trigger pipeline on code commits

> üß© Objective: Push code ‚Üí Auto-provision infra ‚Üí Auto-configure server ‚Üí Deploy App

---

## üîÅ CI/CD Flow

```plaintext
[ Git Push ]
     ‚Üì
[ CI Runner (e.g., GitHub Actions) ]
     ‚Üì
[ Terraform Apply ]
     ‚Üì
[ Generate Ansible Inventory ]
     ‚Üì
[ Ansible Playbook Run ]
     ‚Üì
[ Deployed App on EC2 ]
```

---

## üóÇÔ∏è Folder Structure

```plaintext
cicd-pipeline/
‚îú‚îÄ‚îÄ .github/workflows/deploy.yml      # GitHub Actions CI/CD pipeline
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ inventory.ini                 # (autogenerated)
‚îÇ   ‚îú‚îÄ‚îÄ playbook.yml
‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ       ‚îî‚îÄ‚îÄ index.html.j2
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îî‚îÄ‚îÄ README.md
```

---

## ‚òÅÔ∏è 1. Terraform: Provision AWS Infrastructure

```hcl
# terraform/main.tf

provider "aws" {
  region = "us-east-1"
}

resource "aws_instance" "web" {
  ami           = "ami-0abcdef1234567890"
  instance_type = "t2.micro"
  key_name      = "my-key"
  tags = {
    Name = "ci-web"
  }

  provisioner "local-exec" {
    command = "echo '[web]\n${self.public_ip} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/my-key.pem' > ../ansible/inventory.ini"
  }
}
```

---

## üîß 2. Ansible: Configure the EC2

```yaml
# ansible/playbook.yml

- name: Configure Web Server
  hosts: web
  become: true
  tasks:
    - name: Install NGINX
      yum:
        name: nginx
        state: present

    - name: Deploy App
      copy:
        src: ../app/index.html
        dest: /usr/share/nginx/html/index.html
        mode: '0644'

    - name: Start NGINX
      service:
        name: nginx
        state: started
        enabled: true
```

---

## ü§ñ 3. CI/CD with GitHub Actions

```yaml
# .github/workflows/deploy.yml

name: CI/CD - Terraform + Ansible

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          ansible-playbook -i inventory.ini playbook.yml
```

---

## üîê Secrets Needed (GitHub Settings ‚Üí Secrets)

| Name                  | Description                        |
|-----------------------|------------------------------------|
| `AWS_ACCESS_KEY_ID`   | Your AWS access key                |
| `AWS_SECRET_ACCESS_KEY` | Your AWS secret key             |

You must also upload your **private key (`.pem`)** to the CI runner or use **SSM Session Manager** for agentless access.

---

## ‚úÖ Results

After pushing code to `main`:
- CI/CD pipeline is triggered
- Terraform provisions EC2
- Ansible installs NGINX and deploys your `index.html`
- Your app is live on the public EC2 IP!

---

## üß™ Optional Enhancements

| Feature                       | Tool/Method                       |
|-------------------------------|------------------------------------|
| Dynamic Inventory             | Ansible AWS EC2 plugin            |
| Webhooks or PR triggers       | GitHub/GitLab/Jenkins             |
| Immutable deployments         | Use AMIs or blue/green strategy   |
| Secrets management            | Ansible Vault, SSM Parameter Store|
| Monitoring                    | CloudWatch + Ansible/Grafana      |
| App rollback                  | Ansible tags or versions          |

---

## üìö Resources

- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest)
- [Ansible Docs](https://docs.ansible.com/)
- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Ansible Dynamic Inventory for AWS](https://docs.ansible.com/ansible/latest/plugins/inventory/aws_ec2.html)

---
```

---

### üß∞ Bonus Tip

If you're deploying microservices or more complex apps, consider wrapping this around **Docker + Ansible + Terraform + ECS/EKS** for full containerized orchestration.

Let me know if you want:
- A **diagram-enhanced version**
- A **multi-stage environment** (dev/staging/prod)
- A **rollback strategy**
- Or a **fully containerized pipeline**

